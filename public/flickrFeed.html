<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Flickr Feed API</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="jquery-3.1.1.min.js"></script>



  </head>
  <body>
    <div class="container" id="feed">

      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container" id="nav-bar">
          <div class="col-lg-12" id="header">
            <h1>Random Flickr Feed</h1>
          </div>
        </div>
      </nav>

      <div class="row" id="row">

      </div>

    </div>



    <script type="text/html" id="template">
        <div class="col-lg-3" id="post">
          <div class="col-lg-12" id="box">
            <img class="col-lg-12" id="image" src=<%= imageLink %> />
            <p class="col-lg-12" id="headline"><a href=<%= titleLink %> id="title"><%= title %></a> by <a href=<%= authorLink %> id="author"><%= authorName %></a></p>
            <p class="col-lg-12" id="tags">Tags: <%= tags %></p>
          </div>
        </div>

    </script>

    <script>

      var postTemplate = _.template($("#template").html());

      $.ajax({
        type: "GET",
        dataType: "jsonp",
        url: "https://api.flickr.com/services/feeds/photos_public.gne?format=json"
      });

      function jsonFlickrFeed(json) {
        $.each(json.items, function(i, item) {

          const imageURL = item.media.m;
          const imagePage = item.link;
          const imageTitle = makeTitle(item.title);
          const imageAuthor = createAuthor(item.author);
          const authorURL = "https://www.flickr.com/people/" + item.author_id;
          const imageTags = splitTags(item.tags);

          console.log(imageTitle);

          var postValues = {
            imageLink: imageURL,
            titleLink: imagePage,
            title: imageTitle,
            authorLink: authorURL,
            authorName: imageAuthor,
            tags: imageTags
          }

          $('#row').append(postTemplate(postValues));

        });
      };

      function splitTags(tags) {
        return tags.split(" ").join(", ");
      };

      function createAuthor(author) {
        return author.split(/[""]/)[1];
      };

      function makeTitle(title) {
        if (title.length > 10 ) {
          return title.substr(0, 10) + "...";
        } else {
          return title == " " ? "Untitled" : title;
        }
      };


    </script>
  </body>
</html>
